/*

Parchment
=========

Built: 2011-02-19

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
jQuery.ajaxSetup({cache:1,converters:{"* binary":true}});jQuery.ajaxPrefilter("script",function(a){if(a.isLocal){a.crossDomain=1}});var parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/"},lib:{}};(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.subClass=arguments.callee;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(i,j){var h=String.fromCharCode;return h(i[j])+h(i[j+1])+h(i[j+2])+h(i[j+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};(function(a){window.FatalError=function(b){this.message=b;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(a(".load").length>0){a(".load").detach()}};FatalError.prototype={onError:function(c){var b=c.message;if(typeof c.message=="string"){b=b.entityify()}a("#content").append('<div class="error">An error occurred:<br/><pre>'+b+"\n\n"+c.traceback+"</pre></div>")},_makeTraceback:function(b){var f="";var d=0;var c=100;while(b!=null&&d<c){var g=b.toString();if(!g){f="\n  (anonymous function)"+f}else{var h=g.match(/function (\w*)/);if(!h||!h[1]){f="\n  (anonymous function)"+f}else{f="\n  "+h[1]+f}}try{b=b.caller}catch(i){b=null}d++}if(d==c){f="..."+f}return"Traceback (most recent call last):\n"+f}}})(jQuery);(function(g,e){var f=/chrome\/(\d+)/i.exec(navigator.userAgent),d=f&&parseInt(f[1])>4;function a(p,q){var q=q||[],o=0,n;for(n=p.length%8;o<n;++o){q.push(p.charCodeAt(o)&255)}for(n=p.length;o<n;){q.push(p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255)}return q}function k(r,q){var q=q||"",p=0,n,o=String.fromCharCode;for(n=r.length%8;p<n;++p){q+=o(r[p])}for(n=r.length;p<n;){q+=(o(r[p++])+o(r[p++])+o(r[p++])+o(r[p++])+o(r[p++])+o(r[p++])+o(r[p++])+o(r[p++]))}return q}if(g.atob){var c=function(o,n){return a(atob(o),n)},i=function(o,n){return btoa(k(o,n))}}else{var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b=(function(){var n=[],o=0;for(;o<h.length;o++){n[h.charAt(o)]=o}return n})(),c=function(s,q){var q=q||[],t,p,o,x,w,v,u,r=0,n=s.length;while(r<n){x=b[s.charAt(r++)];w=b[s.charAt(r++)];v=b[s.charAt(r++)];u=b[s.charAt(r++)];t=(x<<2)+(w>>4);p=((w&15)<<4)+(v>>2);o=((v&3)<<6)+u;q.push(t,p,o)}if(u==64){q.pop()}if(v==64){q.pop()}return q},i=function(s,q){var q=q||"",t,p,o,x,w,v,u,r=0,n=s.length;while(r<n){t=s[r++];p=s[r++];o=s[r++];x=t>>2;w=((t&3)<<4)+(p>>4);v=((p&15)<<2)+(o>>6);u=o&63;q+=(h.charAt(x)+h.charAt(w)+h.charAt(v)+h.charAt(u))}if(isNaN(p)){q=q.slice(0,-2)+"=="}else{if(isNaN(o)){q=q.slice(0,-1)+"="}}return q}}var l=jQuery.ajaxSettings.xhr(),j={binary:l.overrideMimeType&&!(e.browser.opera&&parseFloat(e.browser.version)<10.5)?"charset":0},m=function(p,s,o){var r,n,q;if(o.base64){if(g.atob){q=atob(e.trim(p));r=a(q)}else{r=c(e.trim(p))}}else{r=a(e.trim(p))}o.responseArray=r;o.responseText=q};l=undefined;e.ajaxPrefilter("binary",function(o,r,p){var q=o.isLocal&&!o.crossDomain&&d?0:j.binary,n=o.xhr;o.binary=q;p.done(m);o.jsonp=false;o.jsonpCallback="processBase64Zcode";p.base64=1;if(o.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(q&&!o.crossDomain){return"text"}if(o.legacy){o.url=o.legacy;return"jsonp"}o.data="url="+o.url;o.url=parchment.options.proxy_url;if(q&&e.support.cors){return"text"}o.data+="&encode=base64&callback=pproxy";o.jsonpCallback="pproxy";return"jsonp"});e.ajaxPrefilter("text",function(n,p,o){if(n.binary=="charset"){o.base64=0;n.mimeType="text/plain; charset=x-user-defined"}});g.file={text_to_array:a,array_to_text:k,base64_decode:c,base64_encode:i,support:j}})(window,jQuery);(function(a){var c=this,g=a(document),b=a("body"),e=/iPhone|iPod|iPad|Android/i,i=/\S/,d=c.scrollByPages||function(k){var j=g[0].documentElement.clientHeight,l=j-Math.min(j/10,parseInt(b.css("line-height"))*2);scrollBy(0,l*k)},h=c.getSelection||(document.selection&&function(){return document.selection.createRange().text})||function(){return""},f=function(j){return'<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/"+j.path+'">'+j.desc.entityify()+"</a></p>"};c.gIsIphone=e.test(navigator.userAgent);if(a.browser.msie&&parseInt(a.browser.version)<7){a(function(){var k=a("#top-window"),j=function(){k.style.top=document.documentElement.scrollTop+"px"};k.css("position","absolute").resize(j).scroll(j)})}parchment.lib.UI=Object.subClass({init:function(j){this.library=j;this.panels={};this.load_indicator=a('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},stylesheet_add:function(){var j=arguments,k;for(k=1;k<j.length;k++){a("<link>",{rel:"alternate stylesheet",href:j[k],title:j[0]}).appendTo("head")[0].disabled=true}},stylesheet_switch:function(k,j){a('link[rel*="stylesheet"][title="'+k+'"]').each(function(){this.disabled=!j})},load_panels:function(){var j=parchment.options.panels||[],m,l,k=0;if(j.indexOf("search")!=-1){this.panels.search=a('<div class="panel search"><lavel for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search><div></div></div>');m=this.panels.search.find("input");l=m.next();m.bind("keydown.search",function(){m.unbind(".search");a.getJSON("stories/if-archive.json").done(function(n){m.keydown(function(){var p=RegExp(m.val().replace(" ","( )?"),"i"),o=a.grep(n,function(q){return p.test(q.path+q.desc)});o=o.slice(0,30);l.html(a.map(o,f).join(""))})})})}if(j.indexOf("url")!=-1){this.panels.url=a('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.library.container.append(this.panels[j[0]]);this.panels.active=j[0]}});parchment.lib.TextInput=Object.subClass({init:function(j,n){var k=this,j=a(j),m=a("<input>",{autocapitalize:"off",keydown:function(p){var q=p.which,o;if(q==38){k.prev_next(1);o=1}if(q==40){k.prev_next(-1);o=1}if(q==33){d(-1);o=1}if(q==34){d(1);o=1}if(o){return false}}}),l=a("<input>",{"class":"CharInput",keydown:function(o){k.keyCode=o.which},keypress:function(o){k.charCode=o.which;k.submitChar();return false},keyup:function(o){k.submitChar()}});k.form=a("<form>",{"class":"LineInput",submit:function(){k.submitLine();return false}}).append(m);j.bind("click.TextInput",function(){if(h()==""){if(a(".LineInput").length){m.focus()}if(a(".CharInput").length){l.focus()}}});k.history=[];k.container=j;k.stream=a(n);k.lineInput=m;k.charInput=l},die:function(){this.container.unbind(".TextInput")},getLine:function(n,m){var l=this,j=l.stream.children().last(),k=l.lineInput;l.callback=n||a.noop;l.current=0;l.mutable_history=l.history.slice();l.mutable_history.unshift("");l.style=m||"";k.width(l.stream.width()-j.width()).val("").addClass(l.style);j.append(l.form);setTimeout(function(){k.focus()},1)},submitLine:function(){var j=this,k=j.lineInput.val();j.form.detach();j.lineInput.removeClass(j.style);a('<span class="finished-input">'+k.entityify()+"</span><br>").appendTo(j.stream.children().last());if(k!=j.history[0]&&i.test(k)){j.history.unshift(k)}g.trigger({type:"LineInput",input:k});j.callback(k)},prev_next:function(o){var k=this,j=k.lineInput,l=k.mutable_history,m=k.current,n=m+o;if(n<l.length&&n>=0){l[m]=j.val();j.val(l[n]);k.current=n}},getChar:function(l){var k=this,j=k.charInput;k.callback=l||a.noop;k.keyCode=k.charCode=0;k.container.append(j);setTimeout(function(){j.focus()},1)},submitChar:function(){var l=this,m=l.keyCode,j=l.charCode,k={keyCode:m,charCode:j};if(!m&&!j){return}l.charInput.detach();g.trigger({type:"CharInput",input:k});l.callback(k)}})})(jQuery);(function(e,g){var d=/story=([^;&]+)/,f=/([-\w\s_]+)(\.[\w]+(\.js)?)?$/;parchment.lib.Story=IFF.subClass({init:function a(p,k){this.title=k;if(p[0]<9){this.filetype="ok story naked zcode";this._super();this.chunks.push({type:"ZCOD",data:p});this.zcode=p}else{if(IFF.text_from(p,0)=="FORM"){this._super(p);if(this.type=="IFRS"){for(var n=0,j=this.chunks.length;n<j;n++){var o=this.chunks[n].type;if(o=="ZCOD"&&!this.zcode){this.zcode=this.chunks[n].data}else{if(o=="IFmd"){this.metadata=file.array_to_text(this.chunks[n].data);var m=g(this.metadata);if(m){if(g("title",m)){this.title=g("title",m).text()}if(g("ifid",m)){this.ifid=g("ifid",m).text()}if(g("release",m)){this.release=g("release",m).text()}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function b(i){if(this.zcode){i.loadStory(this.zcode)}}});var c=Object.subClass({add:function(i){this[i.ifid]=i;if(i.url){this.url[i.url]=i}},url:{}}),h=Object.subClass({init:function(){this.container=g(parchment.options.container);this.ui=new parchment.lib.UI(this)},load:function(n){var i=this,k=parchment.options,l=d.exec(location.search),j;if(k.lock_story){l=k.default_story}else{if(k.default_story||l){l=l&&unescape(l[1])||k.default_story}else{return this.ui.load_panels()}}g("#about").remove();g("body").append(i.ui.load_indicator);if(!g.isArray(l)){l=[l,0]}j=l[0];i.url=j;storyName=f.exec(j);storyName=storyName?storyName[1]+" - Parchment":"Parchment";if(k.page_title){e.document.title=storyName}try{this.launch(parchment.vms[0],l)}catch(m){throw new FatalError(m)}},launch:function(m,n){var k=this,o=[g.ajax(n[0],{dataType:"binary",legacy:n[1]}).done(function(p,q,i){i.library=k})],j=[],l=0;if(!m.loaded){m.loaded=1;while(l<m.files.length){j.push(g.getScript(parchment.options.lib_path+m.files[l++]))}o[1]=g.when.apply(1,j)}g.when.apply(1,o).done(m.launcher)},stories:new c(),savefiles:{}});parchment.lib.Library=h;parchment.vms=[]})(window,jQuery);parchment.vms.push({files:["gnusto.min.js","zmachine.min.js"],launcher:function(c){var h=window.console&&window.console.log||function(){},g=c[2],d=new GnustoEngine(h),b=new parchment.lib.ZUI(g.library,d,h),f=new EngineRunner(d,b,h),e=new parchment.lib.Story(g.responseArray,storyName),a=location.hash;h("Story type: "+e.filetype);e.load(d);if(a&&a!="#"){d.loadSavedGame(file.base64_decode(a.slice(1)));h("Loading savefile")}f.run()}});(function(a,b){var c=a.parchment;b(function(){if(a.parchment_options){b.extend(c.options,parchment_options)}var d=new c.lib.Library();c.library=d;d.load();if(location.href.indexOf("iplayif.com")!=-1){b.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);